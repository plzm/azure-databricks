{"version":"NotebookV1","origId":3551257439585069,"name":"adb_4_write_to_parquet","language":"python","commands":[{"version":"CommandV1","origId":3551257439585070,"guid":"03639569-89e4-4ebd-b3ed-dfaa44315a89","subtype":"command","commandType":"auto","position":1.0,"command":"# Start with a dataframe - this is from adb_ingest_and_transform\ndf = spark\\\n    .read\\\n    .format(\"csv\")\\\n    .option(\"header\", \"true\")\\\n    .option(\"inferSchema\", \"true\")\\\n    .load(\"/mnt/hack/csv/sample/dat202/airports.csv\")","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543444778525,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"22322b48-2aba-40e4-9224-d38ee40c36a2"},{"version":"CommandV1","origId":3551257439585072,"guid":"649b52fa-0b65-467e-8f85-f1c4ff4a367c","subtype":"command","commandType":"auto","position":2.0,"command":"# coalesce(numPartitions: Int): DataFrame - Returns a new DataFrame that has exactly numPartitions partitions\n# https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame.coalesce\n\ndf\\\n  .coalesce(num_partitions)\\\n  .write\\\n  .parquet(parquet_path)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543444831352,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"cde4886c-dffe-4f27-8fc9-3fed0a9a8a3d"},{"version":"CommandV1","origId":3551257439585073,"guid":"e6370a8a-3768-4a00-9dd2-cde7bf64f2ac","subtype":"command","commandType":"auto","position":3.0,"command":"# Repartition and write\n# https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame.repartition\n\ndf\\\n  .repartition(num_partitions, \"state\")\\\n  .write\\\n  .parquet(parquet_path)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543426377747,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"afeae0df-3f46-44bc-ae94-6690f68a36c8"},{"version":"CommandV1","origId":3551257439585116,"guid":"f8392e48-78d8-4225-a1ae-ebcf8e12c947","subtype":"command","commandType":"auto","position":1.5,"command":"parquet_path = \"/mnt/hack/parquet/sample/dat202/airports\"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543444794600,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1c01fd42-6684-4e69-9eab-03f5136008ad"},{"version":"CommandV1","origId":3551257439585117,"guid":"8db6cd1b-77b7-45ef-8b58-1655296b1483","subtype":"command","commandType":"auto","position":0.5,"command":"%md\nReferences:\n\nhttps://docs.azuredatabricks.net/spark/latest/dataframes-datasets/introduction-to-dataframes-python.html<br>\nhttps://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame (see articles for coalesce(), repartition())<br>\n\nCoalesce: Returns a new DataFrame that has exactly numPartitions partitions.<br>\n\nRepartition: Returns a new DataFrame partitioned by the given partitioning expressions. The resulting DataFrame is hash partitioned.","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1e8fa332-79af-4dc5-b3a7-67419b4f709b"},{"version":"CommandV1","origId":3551257439585127,"guid":"7893d229-5eca-4ab4-a6a7-123802251834","subtype":"command","commandType":"auto","position":1.15625,"command":"num_partitions = 4","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543444781636,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7c3a2974-4941-454c-9b97-f30a9a8fa975"},{"version":"CommandV1","origId":3551257439585128,"guid":"91000d97-d81c-4e98-9f21-9aefa51367bc","subtype":"command","commandType":"auto","position":1.875,"command":"# Cleanup - remove Parquet folder recursively if it already exists\n\ndbutils.fs.rm(parquet_path, True)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543444797584,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8fbf0e0a-de85-419b-957c-2eef0f5c6795"},{"version":"CommandV1","origId":3551257439585129,"guid":"c6f3ef74-9e5c-4b99-bd3b-b19b0f05592d","subtype":"command","commandType":"auto","position":4.0,"command":"# Repartition and write. Here, we are partitioning the output (write.partitionBy) which will create a folder per value in the partition field\n# https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.DataFrame.repartition\n\ndf\\\n  .repartition(num_partitions, \"state\")\\\n  .write\\\n  .partitionBy(\"state\")\\\n  .parquet(parquet_path)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543426469434,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b1b269b3-15e7-41ed-9d5f-d49a478b8d8c"},{"version":"CommandV1","origId":3551257439585131,"guid":"3040c6c4-6623-4a7a-9720-007caeaf3b0f","subtype":"command","commandType":"auto","position":1.25,"command":"print(df.rdd.getNumPartitions())","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543444783568,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a886c779-7fd3-4788-b737-af7bf7798eec"},{"version":"CommandV1","origId":3551257439585132,"guid":"0b8f299e-8149-4eb5-8714-07e2f3d6a8d7","subtype":"command","commandType":"auto","position":1.375,"command":"df2 = df.repartition(num_partitions, \"state\")","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543426011869,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8549b9ff-61dc-4072-8b6d-7fad4d7f8ceb"},{"version":"CommandV1","origId":3551257439585133,"guid":"d5c293a8-e5e8-48e4-86f1-385d96a38214","subtype":"command","commandType":"auto","position":1.4375,"command":"print(df2.rdd.getNumPartitions())","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1543426013084,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"paelaz@microsoft.com","latestUserId":"2080694937739106","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1bdc46d0-88f7-4be1-940d-32c05b992880"},{"version":"CommandV1","origId":3551257439585134,"guid":"72ae3f57-3a75-4b82-b8b9-078d04eaeffa","subtype":"command","commandType":"auto","position":1.125,"command":"%md\n### Partitions and repartitioning","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"fb767e12-95e0-4f74-8990-b43de09bc61d"},{"version":"CommandV1","origId":3551257439585135,"guid":"59b009bd-7dcf-47c2-b662-d015b41287ce","subtype":"command","commandType":"auto","position":1.46875,"command":"%md\n### Parquet","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"04c818e6-ee4c-4de7-a331-705106a99f59"},{"version":"CommandV1","origId":3551257439585136,"guid":"710542d3-2bd0-44ad-9507-48268e77e229","subtype":"command","commandType":"auto","position":1.9375,"command":"%md\n#### Coalesce to a specific number of partitions","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e8b17756-acc7-471f-94a0-e5dbce366cb8"},{"version":"CommandV1","origId":3551257439585137,"guid":"92691e8f-9a04-4161-9c14-69bee0dac6f5","subtype":"command","commandType":"auto","position":5.0,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2745b46d-ef29-48bb-b63a-d948ade82c8f"}],"dashboards":[],"guid":"8e11a023-d42b-4841-ba42-ccf8896b7a7a","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}